import React, { useEffect, useState } from "react";
import { ShowActivationOrGradient } from "../../store/global-states.type";
import { makeStyles } from "@material-ui/core/styles";
import Modal from "@material-ui/core/Modal";
import Backdrop from "@material-ui/core/Backdrop";
import Fade from "@material-ui/core/Fade";
import Popover from "@material-ui/core/Popover";
import CircularProgress from "@material-ui/core/CircularProgress";
import { TensorMetadata } from "./TensorHeatmap";
import RadarChartDrawer, { RadarData } from "./RadarChartDrawer"
import { fetchNodeTensor } from "../../api/layerlevel";

export interface RadarChartProps {
  tensorMetadata: TensorMetadata;
  isShowing: boolean;
  anchorPosition: { top: number, left: number };
  setIsShowing: (boolean) => void;
}

const useStyles = makeStyles((theme) => ({
  modal: {
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
  },
  paper: {
    backgroundColor: theme.palette.background.paper,
    border: "2px solid #000",
    boxShadow: theme.shadows[5],
    padding: theme.spacing(2, 4, 3),
  },
}));

const RadarChart: React.FC<RadarChartProps> = (
  props: RadarChartProps
) => {
  const classes = useStyles();
  const { tensorMetadata, isShowing, setIsShowing, anchorPosition } = props;
  const { type, step, dataIndex, nodeId } = tensorMetadata;
  const isValid = type !== null && step != null && dataIndex !== null;
  const show = isValid && isShowing;
  // const [showLoading, setShowLoading] = useState<boolean>(false);
  const [radarChartData, setRadarChartData] = useState(null);
  const handleClose = () => {
    setIsShowing(false);
  };

  useEffect(() => {
    if (!isValid) return;
    // setShowLoading(true);
    let typeParam;
    if (type === ShowActivationOrGradient.ACTIVATION) {
      typeParam = "activation";
    }
    if (type === ShowActivationOrGradient.GRADIENT) {
      typeParam = "gradient";
    }

    // setShowLoading(false);

    // TODO : 从后端获取数据
    // fetchNodeTensor({
    //   graph_name: "",
    //   node_id: "",
    //   step: 1,
    //   data_index: 1,
    //   type: "",
    //   mode: "",
    //   dim: 1,
    //   scale: false
    // }).then((res) => {
    //   if (res.data.message === "success") {
    //     let rawData = res.data.data;
    //     console.log(rawData);
    //     // setRadarChartData(rawData);
    //   } else {
    //     console.log("获取layer数据失败：" + res.data.message);
    //   }
    // })

    // TODO : 从后端获取数据
    let rawData = [{ "index": "1", "n1": "-0.548031903", "n2": "-0.828123606", "n3": "-0.552783169", "n4": "-0.202678971", "n5": "-0.269561036", "n6": "-0.266353957", "n7": "-0.646522384", "n8": "-0.702767112", "n9": "-0.926860015", "n10": "-0.560093125", "n11": "-0.617033608", "n12": "-0.587159128" }, { "index": "2", "n1": "-0.896649484", "n2": "-0.738511406", "n3": "-0.821765843", "n4": "-0.316063494", "n5": "-0.420933878", "n6": "-0.423994526", "n7": "-0.584270792", "n8": "-0.608287506", "n9": "-0.759527891", "n10": "-0.554661144", "n11": "-0.727861944", "n12": "-0.64570111" }, { "index": "3", "n1": "-0.356236876", "n2": "-0.601031573", "n3": "-0.493134679", "n4": "-0.29131817", "n5": "-0.270285315", "n6": "-0.309733856", "n7": "-0.417644911", "n8": "-0.484887148", "n9": "-0.566314332", "n10": "-0.38086777", "n11": "-0.482574578", "n12": "-0.589780591" }, { "index": "4", "n1": "-1.008064166", "n2": "-0.492137514", "n3": "-0.823405107", "n4": "-0.351499735", "n5": "-0.394041062", "n6": "-0.472141883", "n7": "-0.682133034", "n8": "-0.734196718", "n9": "-0.838340639", "n10": "-0.714294708", "n11": "-0.749486132", "n12": "-0.578254113" }, { "index": "5", "n1": "-0.411085185", "n2": "-0.293348484", "n3": "-0.455053754", "n4": "0.000266685", "n5": "-0.084820347", "n6": "-0.075286817", "n7": "-0.243867176", "n8": "-0.293084514", "n9": "-0.405904746", "n10": "-0.577355426", "n11": "-0.541202853", "n12": "-0.502765324" }, { "index": "6", "n1": "1.100431156", "n2": "0.868038937", "n3": "1.092557977", "n4": "0.248264535", "n5": "0.321048093", "n6": "0.334011104", "n7": "0.508024426", "n8": "0.61315313", "n9": "0.855006533", "n10": "0.507547559", "n11": "0.549994392", "n12": "0.434308774" }, { "index": "7", "n1": "2.332216989", "n2": "1.742973704", "n3": "2.170388386", "n4": "0.386295452", "n5": "0.449379619", "n6": "0.608458381", "n7": "1.362262144", "n8": "1.126509146", "n9": "1.68753993", "n10": "1.422373533", "n11": "1.454658799", "n12": "1.105608326" }, { "index": "8", "n1": "2.026206993", "n2": "1.67996531", "n3": "2.125207677", "n4": "0.475804399", "n5": "0.583583857", "n6": "0.73572968", "n7": "1.460257912", "n8": "1.215758867", "n9": "1.589552224", "n10": "1.416589547", "n11": "1.465171572", "n12": "1.103284894" }, { "index": "9", "n1": "2.043527924", "n2": "1.500344214", "n3": "1.866511162", "n4": "0.469510885", "n5": "0.473680189", "n6": "0.597534541", "n7": "1.18152235", "n8": "1.076600255", "n9": "1.328101373", "n10": "1.302299994", "n11": "1.290273143", "n12": "1.09202849" }, { "index": "10", "n1": "1.123121204", "n2": "1.233718266", "n3": "1.340563689", "n4": "0.601397818", "n5": "0.520634741", "n6": "0.662503158", "n7": "0.945757664", "n8": "0.64470597", "n9": "0.980463681", "n10": "0.730291346", "n11": "1.007448205", "n12": "0.674516111" }, { "index": "11", "n1": "1.270365935", "n2": "1.240178301", "n3": "1.335612042", "n4": "0.504553399", "n5": "0.418276478", "n6": "0.475227906", "n7": "0.498005556", "n8": "0.42589589", "n9": "0.60754185", "n10": "0.344827942", "n11": "0.882460395", "n12": "0.577034577" }, { "index": "12", "n1": "1.19689492", "n2": "1.423296571", "n3": "1.303092879", "n4": "0.69698022", "n5": "0.584726964", "n6": "0.604677453", "n7": "0.313005884", "n8": "0.309444851", "n9": "0.373562828", "n10": "0.169511306", "n11": "0.952494807", "n12": "0.622633207" }, { "index": "13", "n1": "0.805270707", "n2": "1.123343914", "n3": "1.275475572", "n4": "0.313437667", "n5": "0.236338742", "n6": "0.308366966", "n7": "0.112825535", "n8": "0.058828976", "n9": "0.171693699", "n10": "0.170543441", "n11": "0.803293648", "n12": "0.469337995" }, { "index": "14", "n1": "0.914838873", "n2": "1.165757607", "n3": "1.036988792", "n4": "0.490878322", "n5": "0.427061862", "n6": "0.399981907", "n7": "0.398486774", "n8": "0.74224289", "n9": "0.775420116", "n10": "0.730498026", "n11": "1.058412941", "n12": "0.919572236" }, { "index": "15", "n1": "0.786169323", "n2": "1.072487869", "n3": "0.91395375", "n4": "0.784406249", "n5": "0.693207961", "n6": "0.734665797", "n7": "0.875961997", "n8": "0.763759285", "n9": "0.650038891", "n10": "0.587154755", "n11": "0.815912864", "n12": "0.533037501" }, { "index": "16", "n1": "0.435367368", "n2": "0.960550018", "n3": "0.595843702", "n4": "1.321793509", "n5": "1.314197386", "n6": "1.32220728", "n7": "1.324694616", "n8": "1.242881559", "n9": "0.859463661", "n10": "0.876741366", "n11": "0.89610735", "n12": "0.664797609" }, { "index": "17", "n1": "0.362874459", "n2": "1.234359212", "n3": "0.685943557", "n4": "1.873449158", "n5": "1.723845325", "n6": "1.701559791", "n7": "1.772153993", "n8": "1.524243327", "n9": "1.015540031", "n10": "0.965832619", "n11": "1.02818058", "n12": "0.796327781" }, { "index": "18", "n1": "0.419571943", "n2": "0.853662523", "n3": "0.581538131", "n4": "1.545138993", "n5": "1.546870635", "n6": "1.393151595", "n7": "1.257292459", "n8": "1.265783048", "n9": "0.789763483", "n10": "0.891417846", "n11": "0.72367063", "n12": "0.908004367" }, { "index": "19", "n1": "0.704926947", "n2": "0.730194668", "n3": "0.830247741", "n4": "0.570195845", "n5": "0.727599943", "n6": "0.733065275", "n7": "0.646578574", "n8": "0.829450608", "n9": "0.888692803", "n10": "1.436563346", "n11": "1.664918978", "n12": "1.569499526" }, { "index": "20", "n1": "0.792448278", "n2": "0.648337811", "n3": "0.638214717", "n4": "0.381516923", "n5": "0.665997861", "n6": "0.583892037", "n7": "0.614481936", "n8": "0.940801421", "n9": "0.984899773", "n10": "2.108046046", "n11": "2.078172518", "n12": "2.051881585" }, { "index": "21", "n1": "0.787234352", "n2": "0.513567369", "n3": "0.694818262", "n4": "0.337052231", "n5": "0.675720448", "n6": "0.46133004", "n7": "0.719974608", "n8": "0.984712254", "n9": "1.122161132", "n10": "1.789185597", "n11": "1.731380107", "n12": "1.903122084" }, { "index": "22", "n1": "0.86212336", "n2": "0.850724828", "n3": "0.680209317", "n4": "0.47600871", "n5": "0.488428522", "n6": "0.340564865", "n7": "1.102057842", "n8": "1.715011358", "n9": "1.753683969", "n10": "1.632503683", "n11": "1.746047338", "n12": "1.661741871" }, { "index": "23", "n1": "1.245255068", "n2": "0.731686187", "n3": "0.710522049", "n4": "0.446737918", "n5": "0.404709528", "n6": "0.367007976", "n7": "1.516281979", "n8": "2.276329398", "n9": "2.109629819", "n10": "1.36383176", "n11": "1.244427612", "n12": "1.204048134" }, { "index": "24", "n1": "1.287635596", "n2": "0.954120169", "n3": "1.127110077", "n4": "0.46131909", "n5": "0.652372253", "n6": "0.525593429", "n7": "1.304145914", "n8": "1.601466308", "n9": "1.475493472", "n10": "1.293516958", "n11": "1.34857385", "n12": "1.515216757" }, { "index": "25", "n1": "1.374057612", "n2": "1.119114316", "n3": "1.32916616", "n4": "0.513845072", "n5": "0.701166057", "n6": "0.522109036", "n7": "1.244113149", "n8": "1.378215693", "n9": "1.465657448", "n10": "1.04741297", "n11": "0.727237447", "n12": "1.247491744" }, { "index": "26", "n1": "1.345264713", "n2": "0.907681642", "n3": "0.91627524", "n4": "0.673077387", "n5": "0.627226131", "n6": "0.491211815", "n7": "0.738035646", "n8": "1.119047525", "n9": "1.562064025", "n10": "0.492773415", "n11": "0.512163864", "n12": "0.788472054" }, { "index": "27", "n1": "1.219943024", "n2": "0.85367726", "n3": "0.967890742", "n4": "0.59991795", "n5": "0.497872952", "n6": "0.39540153", "n7": "0.567835823", "n8": "0.729471621", "n9": "1.125694562", "n10": "0.295243999", "n11": "0.561327384", "n12": "0.816654346" }, { "index": "28", "n1": "-0.212439616", "n2": "-0.200611034", "n3": "-0.233561266", "n4": "-0.311520905", "n5": "-0.401287957", "n6": "-0.361289581", "n7": "-0.284149917", "n8": "-0.435246987", "n9": "-0.456117054", "n10": "-0.441798061", "n11": "-0.377217653", "n12": "-0.35503837" }, { "index": "29", "n1": "-0.727812153", "n2": "-0.790169638", "n3": "-0.753751862", "n4": "-0.179729967", "n5": "-0.319421065", "n6": "-0.233102341", "n7": "-0.566000122", "n8": "-0.5659236", "n9": "-0.538713202", "n10": "-0.498246084", "n11": "-0.579111814", "n12": "-0.568369089" }, { "index": "30", "n1": "-0.889366801", "n2": "-0.612740965", "n3": "-0.753670315", "n4": "-0.214218653", "n5": "-0.254464018", "n6": "-0.18307237", "n7": "-0.641734815", "n8": "-0.659564725", "n9": "-0.664646265", "n10": "-0.454044", "n11": "-0.513555788", "n12": "-0.46390222" }, { "index": "31", "n1": "-0.426380879", "n2": "-0.657954238", "n3": "-0.556489008", "n4": "-0.389204351", "n5": "-0.273933551", "n6": "-0.330161002", "n7": "-0.587244259", "n8": "-0.495564901", "n9": "-0.761081395", "n10": "-0.465086243", "n11": "-0.722855918", "n12": "-0.576769754" }, { "index": "32", "n1": "-0.767188766", "n2": "-0.521011916", "n3": "-0.674570404", "n4": "-0.111134629", "n5": "-0.178594209", "n6": "-0.232199821", "n7": "-0.279016708", "n8": "-0.562290636", "n9": "-0.639593061", "n10": "-0.514257743", "n11": "-0.711568184", "n12": "-0.501911529" }];

    setRadarChartData(rawData);

  }, [type, step, dataIndex]);

  return (
    <div>
      <Popover
        open={show}
        onClose={handleClose}
        anchorReference="anchorPosition"
        anchorPosition={anchorPosition}
        anchorOrigin={{
          vertical: 'top',
          horizontal: 'right',
        }}
        transformOrigin={{
          vertical: 'bottom',
          horizontal: 'right',
        }}
      >
        <div className={classes.paper}>
          <h2 id="transition-modal-title">
            data type:{" "}
            {type === ShowActivationOrGradient.ACTIVATION && "activation"}{" "}
            {type === ShowActivationOrGradient.GRADIENT && "gradient"}; step:{" "}
            {step} ; data index: {dataIndex}
          </h2>
          {/* {showLoading && <CircularProgress />} */}
          {/* <div className="radarChart"></div> */}
          <RadarChartDrawer rawData={radarChartData} />
        </div>
      </Popover>
    </div>
  );
};

export default RadarChart;
