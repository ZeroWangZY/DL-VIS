<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Force-directed Graph</title>
    <link rel="stylesheet/less" type="text/css" href="index.less">
</head>
<body>
    <div id="main">
        <div id="control-panel">
            <div id="control-panel-title">Force-directed Graph</div>
            <div id="control-panel-content">
                <div id="file-upload">
                    <div id="button-container">
                        <button type="button" onclick="chooseFile()">
                            <span>Choose a file</span>
                        </button>
                        <span id="filename"></span>
                        <input type="file" id="btn_file" style="display:none" onchange="uploadFile()"/>
                    </div>
                </div>
                <div id="graph-options">
                    <div>
                        <span>Display label:</span>
                        <input type="checkbox" class="display-checkbox" onchange="changeLabelDisplay()" id="dispaly-label">
                    </div>
                    <div>
                        <span>Display arrow:</span>
                        <input type="checkbox" class="display-checkbox" onchange="changeArrowDisplay()" id="dispaly-arrow">
                    </div>
                    <div>
                        <span>Force distance:</span>
                        <input type="range" onchange="changeDistance()" id="distance-range" min="5" max="200" value="30"></input>
                    </div>
                </div>
                <div id="node-filter">
                    <div id="sub-title">Operation filter</div>
                    <ul class="filter-list scroll-box" id="list-ul">
                        <li class="filter-list-item">
                            <label class="filter-check">
                                <input type="checkbox" id="checkbox-all" checked onclick="filterCheckAll()" class="filter-check-checkbox">
                                <span class="filter-check-checkbox checkbox-background"></span>
                                <span class="filter-check-checkbox checkbox-border"></span>
                                <span class="filter-check-text">Select all</span>
                            </label>
                        </li>
                    </ul>
                    <button onclick="filterOperation()">Apply</button>
                </div>
            </div>
        </div>
        <div id="graph-container">
            <div id="svg-container">
                <svg>
                    <defs>
                        <marker id="arrow" 
                                markerUnits="strokeWidth" 
                                markerWidth="4" 
                                markerHeight="4" 
                                viewBox="0 0 4 4" 
                                refX="8" 
                                refY="2" 
                                orient="auto">
                                <path d="M0,0 L4,2  L0,4 L2,2 L0,0" style="fill: #4d4d4d;" />
                        </marker>
                        <pattern id="person" patternUnits="objectBoundingBox" width="1" height="1">
                            　　<rect x="3" y="3" width="10" height="10" fill="#7FBBA1" stroke="#5CA083"/>
                        </pattern>
                    </defs>
                </svg>
            </div>
        </div>
    </div>
</body>
<script src="less/less.js" type="text/javascript"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="draw.js"></script>
<script src="brush.js"></script>
<script src="parser.js"></script>
<script src="hierarchy.js"></script>
<script>
    let svgContainer = d3.select('#svg-container');
    let defaultDistance = 30;
    let checkedOp = []; // 勾选的operation
    let graph = {}; // 存储d3画图所需数据 不带层级关系
    let hierarchyGraph = {};// 带层级关系的图
    let testGraph = {
                        "nodes": [
                            {"id": "mul_1", "group": 1},
                            {"id": "AssignAdd", "group": 2},
                            {"id": "add", "group": 1},
                            {"id": "mul", "group": 2},
                            {"id": "x", "group": 1},
                            // {"id": "111", "group": 1},
                            // {"id": "222", "group": 4},
                            // {"id": "333", "group": 2},
                            // {"id": "444", "group": 2},
                            // {"id": "555", "group": 1},
                            {
                                "id": "temperature",
                                "group":1,
                                "child": {
                                    "nodes": [
                                        {"id": "sub", "group": 3},
                                        {"id": "temperature", "group": 3},
                                        {"id": "current", "group": 4},
                                        {"id": "difference", "group": 2},
                                        {"id": "y", "group": 5},
                                        
                                    ],
                                    "links": [
                                        {"source": "y", "target": "sub"},
                                        {"source": "sub", "target": "difference"},
                                        {"source": "temperature", "target": "current"},
                                        {"source": "temperature", "target": "sub"},
                                        {"source": "sub", "target": "add"},
                                        {"source": "AssignAdd", "target": "temperature"},

                                    ]
                                }
                            }
                        ],
                        "links": [
                                {"source": "mul_1", "target": "AssignAdd"},
                                {"source": "x", "target": "mul_1"},
                                {"source": "add", "target": "mul_1"},
                                {"source": "mul", "target": "add"},
                                {"source": "temperature", "target": "add"},
                                {"source": "AssignAdd", "target": "temperature"},  
                                // {"source": "111", "target": "mul_1"},
                                // {"source": "mul", "target": "222"},
                                // {"source": "333", "target": "111"},
                                // {"source": "AssignAdd", "target": "555"},
                                // {"source": "444", "target": "mul_1"},
                                // {"source": "m555ul", "target": "add"},
                                // {"source": "temperature", "target": "333"},
                                // {"source": "333", "target": "temperature"}    
                        ]
                        };
        // drawGraph(testGraph, defaultDistance, [1,2,3,4,5]);

    // 选择文件
    function chooseFile() { 
        document.getElementById("btn_file").click(); 
    }

    // 上传pbtxt文件并解析graph和operations
    function uploadFile() {
        let file = window.event.target.files;
        let fileName = '';
        if (file.length) {
            fileName = file[0].name;
            if (fileName.split('.')[1] !== "pbtxt") {
                alert("Invalid file type!");
                return;
            }
            document.getElementById("filename").innerText = fileName;
            let reader = new FileReader();
            reader.onload = function(){
                parseGraphPbTxt(this.result).then(pbtxtData => {
                    graph = buildGraph(pbtxtData);
                    hierarchyGraph = hierarchyBuild(graph);
                    // 把op提取出来
                    let nodes = graph.nodes;
                    let groups = [];
                    for (let node of nodes) {
                        if (groups.indexOf(node.group) == -1) {
                            groups.push(node.group);
                        }
                    }
                    checkedOp = groups.concat();
                    updateFilerList(groups);
                    drawGraph(graph, defaultDistance, checkedOp, true);
                });
            };
            reader.readAsArrayBuffer(file[0]);
        }
    }

    // 修改力引导图中的distance
    function changeDistance () {
        let value = document.getElementById("distance-range").value;
        defaultDistance = value;
        drawGraph(hierarchyGraph, value, checkedOp);
    }

    // 全选 or 取消全选
    function filterCheckAll () {
        let all = document.getElementById('checkbox-all'); 
        let other = document.getElementsByName('filter-checkbox');
        for(let i = 0; i < other.length; i++) {
            other[i].checked=all.checked;
        }
    }
    
    // 更新operation list 初始时默认全选
    function updateFilerList (groups) {
        let ul = document.getElementById("list-ul");
        let all = document.getElementById('checkbox-all'); 
        all.checked = true;//每次加载新文件默认全选
        // 删除上一个文件的li
        while (ul.childElementCount > 1) {
            ul.removeChild(ul.lastChild);
        }
        for (let i = 0; i < groups.length; i++) {
            let checkBox = document.createElement("input");  
            checkBox.setAttribute("type","checkbox");
            checkBox.setAttribute("name", "filter-checkbox");
            checkBox.setAttribute("class", "filter-check-checkbox");
            checkBox.setAttribute("checked","true");
            checkBox.setAttribute("onclick", "changeOp()");
            let span1 = document.createElement("span"); 
            let span2 = document.createElement("span"); 
            let span3 = document.createElement("span"); 
            span1.setAttribute("class", "filter-check-checkbox checkbox-background");
            span2.setAttribute("class", "filter-check-checkbox checkbox-border");
            span3.setAttribute("class", "filter-check-text")
            let text = document.createTextNode(groups[i]);
            span3.appendChild(text);
            let label = document.createElement('label');
            label.setAttribute("class", "filter-check");
            label.appendChild(checkBox);
            label.appendChild(span1);
            label.appendChild(span2);
            label.appendChild(span3);
            let li = document.createElement("li");  
            li.setAttribute("class", "filter-list-item")
            li.appendChild(label);
            ul.appendChild(li);
        }
    }

    // 应用filter
    function filterOperation () {
        checkedOp = [];
        let operations = document.getElementsByName('filter-checkbox');
        for(let i = 0; i < operations.length; i++) {
            if(operations[i].checked) {
                checkedOp.push(operations[i].parentNode.lastElementChild.innerText);
            }
        }
        drawGraph(hierarchyGraph, defaultDistance, checkedOp);
    }

    // filter 勾选操作
    function changeOp() {
        let allFlag = true;
        let operations = document.getElementsByName('filter-checkbox');
        for(let i = 0; i < operations.length; i++) {
            if (!operations[i].checked) {
                allFlag = false;
            }
        }
        let all = document.getElementById('checkbox-all'); 
        all.checked = allFlag;
    }
</script>
</html>